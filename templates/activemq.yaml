name: activemq
remark: 用于activemq项目的自动部署
aliass:
  - aliasName: IPs
    aliasValue: "if (this.hosts.length > 1) {return failover:({{this.hosts.map(function(host){return 'tcp://' + host.ip + ':' + this.attrs.t_defaultPort}).join(',')}})?randomize=false } else { return this.hosts.map(function(host){return 'tcp://' + host.ip + ':' + this.attrs.t_defaultPort}).join(',') }"
    aliasDesc: "获取activemq项目当前环境机器列表"
items:
  - itemName: t_defaultPort
    itemDesc: 默认端口
    default: '61616'
actions:
  - name: 部署activemq
    css: glyphicon glyphicon-import
    steps:
      - name: 加固os
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' os.security"
      - name: 安装ntp服务
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' ntp"
      - name: 安装java
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' java.install"
      - name: 编译安装activemq
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' activemq pillar='{activemq: {openwire: {{attrs.t_defaultPort}}}}'"

  - name: 重启activemq
    css: glyphicon glyphicon-repeat
    steps:
      - name: 重启activemq
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' activemq.restart"

  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动activemq应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' activemq.start"

  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' activemq.stop"