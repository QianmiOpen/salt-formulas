#"nfsServer" -> nfsServer
#"repository" -> repository
#"taskId" -> taskId
#"projectName" -> projectName
#"machine" -> machine
#"syndic" -> syndic
#"version" -> version

name: webui
remark: 用于web项目的自动部署，即前端服务类项目
items:
  - itemName: t.groupId
    itemDesc: groupId
  - itemName: t.artifactId
    itemDesc: artifactId
  - itemName: t.mountDir
    itemDesc: 日志绑定目录
  - itemName: t.unpacked
    itemDesc: 自动解压
    default: 'False'
actions:
  - name: 升级应用
    css: glyphicon glyphicon-upload
    versionMenu: True
    steps:
      - name: 记录任务开始状态
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' git.tag pillar='{git: {taskId: {{t.taskId}}, stage: before, version: {{t.version}}}}'"
      - name: 关闭应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.shutdown"
      - name: 部署war包
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' webapp.deploy pillar='{webapp: {groupId: {{t.groupId}}, artifactId: {{t.artifactId}}, version: {{t.version}}, repository: {{t.repository}}, unzip: {{t.unpacked}}}}'"
      - name: 配置文件准备
        sls: "bugatti copyfile"
      - name: 拷贝配置文件
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' job.copyfile pillar='{job: {confFileName: {{t.confFileName}}, id: {{t.taskId}}}}'"
      - name: 记录任务结束状态
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' git.tag pillar='{git: {taskId: {{t.taskId}}, stage: after, version: {{t.version}}}}'"
      - name: 启动应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.startup"
  - name: 安装应用
    css: glyphicon glyphicon-import
    versionMenu: True
    steps:
      - name: 加固os
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' os.security"
      - name: 安装ntp服务
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' ntp"
      - name: 安装java
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' java.install"
        seconds: 10
      - name: 记录任务开始状态
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' git.tag pillar='{git: {taskId: {{t.taskId}}, stage: before, version: {{t.version}}}}'"
      - name: 安装tomcat
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.install"
        seconds: 6
      - name: mount log目录
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' webapp.mountlog pillar='{webapp: {nfsServer: {{t.nfsServer}}, projectName: {{t.mountDir}}}}'"
      - name: 关闭应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.shutdown"
      - name: 部署war包
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' webapp.deploy pillar='{webapp: {groupId: {{t.groupId}}, artifactId: {{t.artifactId}}, version: {{t.version}}, repository: {{t.repository}}, unzip: {{t.unpacked}}}}'"
      - name: 配置文件准备
        sls: "bugatti copyfile"
      - name: 拷贝配置文件
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' job.copyfile pillar='{job: {confFileName: {{t.confFileName}}, id: {{t.taskId}}}}'"
      - name: 记录任务结束状态
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' git.tag pillar='{git: {taskId: {{t.taskId}}, stage: after, version: {{t.version}}}}'"
      - name: 启动应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.startup"
  - name: 重启应用
    css: glyphicon glyphicon-repeat
    steps:
      - name: 关闭应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.shutdown"
      - name: 启动应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.startup"
  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.startup"
  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      - name: 关闭应用
        sls: "salt {{t.machine}} state.sls saltenv='{{t.scriptVersion}}' tomcat.shutdown"
