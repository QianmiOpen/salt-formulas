name: webapi
remark: 用于dubbo项目的自动部署，即api类项目
dependences:
  - name: "$logServer"
    type: nfs
    description: 日志服务器
    default: LogServer
  - name: "$dubboRegister"
    type: zookeeper
    description: dubbo注册中心
    default: ZookeeperRegister
  - name: "$logredis"
    type: redis
    description: 日志服务器
    default: LogstashRedis
  - name: "$dubboadmin"
    type: dubboadmin
    description: DubboAdmin服务器
    default: DubboAdmin
aliass:
  - aliasName: LogServerVIp
    aliasValue: "dependence.$logServer.attrs.t_virtualIp"
    aliasDesc: "获取zookeeper register项目当前环境机器列表，以','分割"
  - aliasName: ZookeeperRegisterIps
    aliasValue: "dependence.$dubboRegister.alias.IPs"
    aliasDesc: "获取zookeeper register项目当前环境机器列表，以','分割"
  - aliasName: CATALINA_HOME
    aliasValue: "'/home/tomcat/tomcat'"
    aliasDesc: "获取CATALINA_HOME"
  - aliasName: HOME
    aliasValue: "'/home/tomcat'"
    aliasDesc: "获取HOME"
  - aliasName: AuthUsers
    aliasValue: "function(project){if(this.env.level == 'safe'){return this.leaders.join()}else{return (this.leaders.concat(this.members)).join()}}.call(this, project)"
    aliasDesc: "获取用户列表，以','分割"
items:
  - itemName: t_groupId
    itemDesc: groupId
  - itemName: t_artifactId
    itemDesc: artifactId
  - itemName: t_mountDir
    itemDesc: 日志绑定目录
  - itemName: t_jdkversion
    itemDesc: jdk版本
    default: 'jdk7'
  - itemName: t_unpacked
    itemDesc: 自动解压
    default: 'False'
actions:
  - name: 升级应用
    css: glyphicon glyphicon-upload
    versionMenu: True
    steps:
      # - name: 停止dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubbodown pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.shutdown"
      - name: 部署war包
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.deploy pillar='{webapp: {groupId: {{attrs.t_groupId}}, artifactId: {{attrs.t_artifactId}}, version: {{version.name}}, unzip: {{attrs.t_unpacked}}}}'"
      - name: 配置文件准备
        sls: "bugatti copyfile"
      - name: 拷贝配置文件
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' job.copyfile pillar='{job: {confFileName: {{confFileName}}, id: {{env.id}}/{{id}}/{{taskId}}, baseUrl: \"{{system.baseUrl}}\"}}'"
  - name: 安装应用
    css: glyphicon glyphicon-import
    versionMenu: True
    steps:
      # - name: 加固os
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' os.security"
      # - name: 安装ntp服务
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' ntp"
      - name: 安装java
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' java.install pillar='{java: {version: {{attrs.t_jdkversion}}}}'"
        seconds: 10
      # - name: 停止dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubbodown pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.shutdown"
      - name: 安装tomcat
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.install pillar='{tomcat: {logstashRedisHost: \"{{dependence.$logredis.attrs.t_virtualIp}}\", logstashRedisPort: {{dependence.$logredis.attrs.t_port}}}}'"
        seconds: 6
      - name: mount log目录
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.mountlog pillar='{webapp: {nfsServer: {{alias.LogServerVIp}}, projectName: {{attrs.t_mountDir}}, logHome: {{dependence.$logServer.attrs.t_mountRootDir}}}}'"
      - name: 部署war包
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.deploy pillar='{webapp: {groupId: {{attrs.t_groupId}}, artifactId: {{attrs.t_artifactId}}, version: {{version.name}}, unzip: {{attrs.t_unpacked}}}}'"
      - name: 配置文件准备
        sls: "bugatti copyfile"
      - name: 拷贝配置文件
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' job.copyfile pillar='{job: {confFileName: {{confFileName}}, id: {{env.id}}/{{id}}/{{taskId}}, baseUrl: \"{{system.baseUrl}}\"}}'"
  - name: 重启应用
    css: glyphicon glyphicon-repeat
    versionMenu: True
    steps:
      # - name: 停止dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubbodown pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.shutdown"
      - name: 配置文件准备
        sls: "bugatti copyfile"
      - name: 拷贝配置文件
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' job.copyfile pillar='{job: {confFileName: {{confFileName}}, id: {{env.id}}/{{id}}/{{taskId}}, baseUrl: \"{{system.baseUrl}}\"}}'"
      - name: 启动应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.startup"
      # - name: 启用dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubboup pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.startup"
      # - name: 启用dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubboup pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      # - name: 停止dubbo接口
      #   sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.dubbodown pillar='{webapp: {dubboAdminIp: {{dependence.$dubboadmin.hosts[0].ip}}, dubboRootPasswd: {{dependence.$dubboadmin.attrs.t_rootPassword}}}}'"
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' tomcat.shutdown"
  - name: jstack
    css: glyphicon glyphicon-camera
    actionType: host
    steps:
      - name: jstack
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.jstack"
  - name: auth
    css: glyphicon glyphicon-user
    actionType: host
    steps:
      - name: 处理证书文件
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' webapp.auth pillar='{auth: {users: \"{{alias.AuthUsers}}\"}}'"

