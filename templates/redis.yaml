name: redis
remark: 用于redis项目的自动部署
items:
  - itemName: t_virtualRouterId
    itemDesc: 虚拟路由ID
    default: '166'
  - itemName: t_isMaster
    itemDesc: 是否主机
    itemType: var
    default: 'True'
  - itemName: t_virtualIp
    itemDesc: 虚拟IP地址
    itemType: var
    default: '172.19.22.50'
  - itemName: t_databases
    itemDesc: redis数据库数
    itemType: var
    default: '500'
  - itemName: t_port
    itemDesc: redis端口
    itemType: var
    default: '6379' 
  - itemName: t_isSaveDBFile
    itemDesc: 是否本地数据持久化
    itemType: var
    default: 'True'         
actions:
  - name: 部署redis
    css: glyphicon glyphicon-import
    steps:
      #- name: 加固os
      #  sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' os.security"
      #- name: 安装ntp服务
      #  sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' ntp"
      - name: 编译安装keepalived
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' keepalived pillar='{keepalived: {isMaster: {{attrs.t_isMaster}}, virtual_router_id: {{attrs.t_virtualRouterId}}, virtual_ipaddress: \"{{attrs.t_virtualIp}}\"}}'"
      - name: 编译安装redis
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' redis pillar='{redis: {databases: {{attrs.t_databases}}, port: {{attrs.t_port}}, isSaveDBFile: {{attrs.t_isSaveDBFile}}}}'"


  - name: 重启redis
    css: glyphicon glyphicon-repeat
    steps:
      - name: 重启redis
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' redis.restart"

  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动redis应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' redis.start"

  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' redis.stop"
