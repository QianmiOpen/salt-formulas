name: zookeeper
remark: 用于zookeeper项目的自动部署
aliass:
  - aliasName: zookeeperHostNames
    aliasValue: "hosts.map(function(host){return host.name}).join(',')"
    aliasDesc: "获取zookeeper register项目当前环境机器列表，以','分割"
items:
  - itemName: t_defaultPort
    itemDesc: 默认端口
    default: '2181'
actions:
  - name: 部署zookeeper
    css: glyphicon glyphicon-import
    steps:
      - name: 加固os
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' os.security"
      - name: 安装ntp服务
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' ntp"
      - name: 编译安装zookeeper
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' zookeeper pillar='{zookeeper: {hostslist: \"{{ hosts.map(function(host){return host.ip}).join(',') }}\", hostip: {{ cHost.ip }}}}"
      - name: 刷新所有zookeeper主机配置
        sls: "salt -L {{alias.zookeeperHostNames}} state.sls saltenv='{{env.scriptVersion}}' zookeeper pillar='{zookeeper: {hostslist: "{{ hosts.map(function(host){return host.ip}).join(',') }}", hostip: {{ cHost.ip }}}}"
      - name: 重新加载所有zookeeper主机配置
        sls: "salt -L {{alias.zookeeperHostNames}} state.sls saltenv='{{env.scriptVersion}}' zookeeper.restart"

  - name: 重启zookeeper
    css: glyphicon glyphicon-repeat
    steps:
      - name: 重启zookeeper
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' zookeeper.restart"

  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动zookeeper应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' zookeeper.start"

  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' zookeeper.stop"
