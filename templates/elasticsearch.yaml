name: elasticsearch
remark: 用于elasticsearch项目的自动部署
dependences:
  - name: "$logServer"
    type: nfs
    description: 日志服务器
    default: LogServer
aliass:
  - aliasName: LogServerVIp
    aliasValue: "dependence.$logServer.attrs.t_virtualIp"
    aliasDesc: "获取nfs服务器地址"
items:
  - itemName: t_clustername
    itemDesc: 集群名称
    itemType: var
    default: 'elasticsearch'
  - itemName: t_numberofshards
    itemDesc: 分片数量
    itemType: var
    default: '5'
  - itemName: t_numberofreplicas
    itemDesc: 副本数量
    itemType: var
    default: '1'

actions:
  - name: 部署elasticsearch
    css: glyphicon glyphicon-import
    steps:
      #- name: 加固os
      #  sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' os.security"
      #- name: 安装ntp服务
      #  sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' ntp"
      - name: 安装java
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' java.install"
      - name: 编译安装elasticsearch
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' elasticsearch.install pillar='{elasticsearch: {nodename: {{cHost.name}}, clustername: {{attrs.t_clustername}}, number_of_shards: {{attrs.t_numberofshards}}, number_of_replicas: {{attrs.t_numberofreplicas}}, nfsServer: {{alias.LogServerVIp}}}}'"

  - name: 重启elasticsearch
    css: glyphicon glyphicon-repeat
    steps:
      - name: 重启elasticsearch
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' elasticsearch.restart"

  - name: 启动应用
    css: glyphicon glyphicon-play
    steps:
      - name: 启动elasticsearch应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' elasticsearch.start"

  - name: 停止应用
    css: glyphicon glyphicon-stop
    steps:
      - name: 关闭应用
        sls: "salt {{cHost.name}} state.sls saltenv='{{env.scriptVersion}}' elasticsearch.stop"
        